def credential = 'kelompok3'
def server = 'grup3@116.193.190.138'
def directory = 'housy-backend'
def url = 'https://github.com/Indizzy/housy-backend.git'
def branch = 'main'
def images = 'indizzy/housy-backend:v1'

pipeline{
  agent any
  stages{
     stage('Pull From Backend Repo') {
         steps {
            sshagent([credential]) {
                sh """ssh -o StrictHostkeyChecking=no ${server} << EOF
                cd ${directory}
                git remote add origin ${url} || git remote set-url origin ${url}
                git pull ${url} ${branch}
                exit
                EOF"""
              }
          }
      }
      stage('building database'){
	  steps{
	     sshagent ([credential]){
                 sh """ssh -o StrictHostkeyChecking=no ${server} << EOF
		 docker compose up -d
                 exit
                 EOF"""
	     }
	}
     } 
      stage('building docker images'){
          steps{
              sshagent ([credential]) {
                  sh """ssh -o StrictHostkeyChecking=no ${server} << EOF
                  cd ${directory}
                  docker-compose -f fe-be.yaml
                  exit
                  EOF"""
              }
          }
      }
    stage('Push to Docker Hub') {
            steps {
                sshagent([credential]) {
			sh """ssh -o StrictHostkeyChecking=no ${server} << EOF
			docker tag ${imagename}:${env.BUILD_ID} ${dockerusername}/${imagename}:${env.BUILD_ID}
			docker tag ${imagename}:latest ${dockerusername}/${imagename}:latest
			docker image push ${dockerusername}/${imagename}:latest
			docker image push ${dockerusername}/${imagename}:${env.BUILD_ID}
			docker image rm ${dockerusername}/${imagename}:latest
			docker image rm ${dockerusername}/${imagename}:${env.BUILD_ID}
			docker image rm ${imagename}:${env.BUILD_ID}
			EOF"""
		}
	    }
        }
  }

}
