def credential = 'kelompok3'
def server = 'grup3@116.193.190.138'
def directory = 'housy-backend'
def branch = 'main'
def images = 'grup3/housy-backend:v1'

pipeline{
  agent any
  stages{
      stage ('docker compose down and pulling new images'){
          steps{
              sshagent ([credential]) {
                  sh """ssh -o StrictHostkeyChecking=no ${server} << EOF
                  cd ${directory}
                  docker-compose down
                  docker system prune -f 
                  git pull origin ${branch}
                  exit
                  EOF"""
              }
          }
      }
      stage ('building docker images'){
          steps{
              sshagent ([credential]) {
                  sh """ssh -o StrictHostkeyChecking=no ${server} << EOF
                  cd ${directory}
                  docker build -t ${images} .
                  exit
                  EOF"""
              }
          }       
      }
      stage ('docker up'){
          steps{
              sshagent ([credential]) {
                  sh """ssh -o StrictHostkeyChecking=no ${server} << EOF
                  cd ${directory}
                  docker-compose up -d
                  exit
                  EOF"""
              }
          }
      }
  }

}
